<?xml version="1.0" encoding="utf-8" ?>
<Defs>
	<XmlExtensions.PatchDef Name="MoodMatters_MoodPatch" Abstract="True">
		<parameters>
			<li>stat</li> <!--Name of stat (no spaces)-->
			<li>label</li> <!--Label for settings menu-->
			<li>defName</li> <!--defname of the StatDef-->
			<li>defaultMin</li> <!--Default min modifier-->
			<li>defaultMax</li> <!--Default max modifier-->
		</parameters>
		<apply>
		
			<!--Apply the initial patch-->
			<Operation Class="XmlExtensions.OptionalPatch">
				<modId>imranfish.moodmatters</modId>
				<key>patch{stat}</key>
				<defaultValue>true</defaultValue>
				<caseTrue> 
					<Operation Class="XmlExtensions.AggregateValues">
						<valueOperations>
							<!--Load the max mood modifier-->
							<Operation Class="XmlExtensions.UseSetting">
								<modId>imranfish.moodmatters</modId>
								<key>{stat}max</key>
								<defaultValue>{defaultMax}</defaultValue>
							</Operation>
							<!--Load the min mood modifier-->
							<Operation Class="XmlExtensions.UseSetting">
								<modId>imranfish.moodmatters</modId>
								<key>{stat}min</key>
								<defaultValue>{defaultMin}</defaultValue>
							</Operation>
							<!--Convert max mood modifier to a multiplier-->
							<Operation Class="XmlExtensions.CreateVariable">
								<storeIn>{stat}maxmultiplier</storeIn>
								<value>{{stat}max}</value>
								<value2>100</value2>
								<operation>/</operation>
							</Operation>
							<!--Convert min mood modifier to a multiplier-->
							<Operation Class="XmlExtensions.CreateVariable">
								<storeIn>{stat}minmultiplier</storeIn>
								<value>{{stat}min}</value>
								<value2>100</value2>
								<operation>/</operation>
							</Operation>
						</valueOperations>
						<apply>
							<!--Some stats already have a <parts> node, so using SafeAdd instead-->
							<Operation Class="XmlExtensions.PatchOperationSafeAdd">
								<xpath>Defs/StatDef[defName="{defName}"]</xpath>
								<safetyDepth>1</safetyDepth>
								<value>
									<parts>
										<li Class="StatPart_Mood">
											<factorFromMoodCurve>
												<points>
													<li>(0,{{stat}minmultiplier})</li>
													<li>(1,{{stat}maxmultiplier})</li>
												</points>
											</factorFromMoodCurve>
										</li>
									</parts>
								</value>
							</Operation>
						</apply>
					</Operation>
				</caseTrue>
			</Operation>
		
			<!--Add new settings to the menu-->
			<Operation Class="XmlExtensions.ApplyPatch">
				<patchName>MoodMatters_InjectSettings</patchName>
				<arguments>
					<li>{stat}</li>
					<li>{label}</li>
					<li>{defaultMin}</li>
					<li>{defaultMax}</li>
				</arguments>
			</Operation>
			
			<!--Make it so you do not need to reboot game-->
			<Operation Class="PatchOperationAdd">
				<xpath>Defs/XmlExtensions.SettingsMenuDef[modId="imranfish.moodmatters"]/postCloseActions</xpath>
				<value>
					<li Class="XmlExtensions.Action.ApplyOperations">
						<apply>
							<Operation Class="XmlExtensions.OptionalPatch">
								<modId>imranfish.moodmatters</modId>
								<key>patch{stat}</key>
								<defaultValue>true</defaultValue>
								<caseTrue>
									<Operation Class="XmlExtensions.AggregateValues">
										<valueOperations>
											<Operation Class="XmlExtensions.UseSetting">
												<modId>imranfish.moodmatters</modId>
												<key>{stat}max</key>
												<defaultValue>{defaultMax}</defaultValue>
											</Operation>
											<Operation Class="XmlExtensions.UseSetting">
												<modId>imranfish.moodmatters</modId>
												<key>{stat}min</key>
												<defaultValue>{defaultMin}</defaultValue>
											</Operation>
											<Operation Class="XmlExtensions.CreateVariable">
												<storeIn>{stat}maxmultiplier</storeIn>
												<value>{{stat}max}</value>
												<value2>100</value2>
												<operation>/</operation>
											</Operation>
											<Operation Class="XmlExtensions.CreateVariable">
												<storeIn>{stat}minmultiplier</storeIn>
												<value>{{stat}min}</value>
												<value2>100</value2>
												<operation>/</operation>
											</Operation>
										</valueOperations>
										<apply>
											<!--Use DefDatabase operations instead-->
											<Operation Class="XmlExtensions.DefDatabaseConditional">
												<defType>StatDef</defType>
												<defName>{defName}</defName>
												<objPath>parts/[@Class="StatPart_Mood"]</objPath>
												<caseTrue>
													<Operation Class="XmlExtensions.DefDatabaseOperationReplace">
														<defType>StatDef</defType>
														<defName>{defName}</defName>
														<objPath>parts/[@Class="StatPart_Mood"]/factorFromMoodCurve/points</objPath>
														<value>
															<points>
																<li>(0,{{stat}minmultiplier})</li>
																<li>(1,{{stat}maxmultiplier})</li>
															</points>
														</value>
													</Operation>
												</caseTrue>
												<caseFalse>
													<Operation Class="XmlExtensions.DefDatabaseOperationAdd">
														<defType>StatDef</defType>
														<defName>{defName}</defName>
														<objPath>parts</objPath>
														<value>
															<li Class="StatPart_Mood">
																<factorFromMoodCurve>
																	<points>
																		<li>(0,{{stat}minmultiplier})</li>
																		<li>(1,{{stat}maxmultiplier})</li>
																	</points>
																</factorFromMoodCurve>
															</li>
														</value>
													</Operation>
												</caseFalse>
											</Operation>
										</apply>
									</Operation>
								</caseTrue>
								<caseFalse>
									<Operation Class="XmlExtensions.DefDatabaseConditional">
										<defType>StatDef</defType>
										<defName>{defName}</defName>
										<objPath>parts/[@Class="StatPart_Mood"]</objPath>
										<caseTrue>
											<Operation Class="XmlExtensions.DefDatabaseOperationRemove">
												<defType>StatDef</defType>
												<defName>{defName}</defName>
												<objPath>parts/[@Class="StatPart_Mood"]</objPath>
											</Operation>
										</caseTrue>
									</Operation>
								</caseFalse>
							</Operation>
						</apply>
					</li>
				</value>
			</Operation>
			
		</apply>
	</XmlExtensions.PatchDef>
	<XmlExtensions.PatchDef Name="MoodMatters_InjectSettings" Abstract="True">
		<parameters>
			<li>stat</li>
			<!--Name of stat (no spaces)-->
			<li>label</li>
			<!--Label for settings menu-->
			<li>defaultMin</li>
			<!--Default min modifier-->
			<li>defaultMax</li>
			<!--Default max modifier-->
		</parameters>
		<apply>
			<!--Load the <col> value from the SlateDef-->
			<Operation Class="XmlExtensions.CreateVariable">
				<value>Defs/XmlExtensions.SlateDef[@Name="MoodMatters_Slate"]/col</value>
				<fromXml>true</fromXml>
				<storeIn>col</storeIn>
				<apply>
					<Operation Class="XmlExtensions.PatchByCase">
						<value>{col}</value>
						<cases>
							<li>
								<!--LeftCol case-->
								<value>left</value>
								<apply>
									<Operation Class="PatchOperationInsert">
										<xpath>Defs/XmlExtensions.SettingsMenuDef[modId="imranfish.moodmatters"]/settings/li[@Class="XmlExtensions.Setting.ResetSettings"]</xpath>
										<order>Prepend</order>
										<value>
											<!--Because we are prepending, we insert the settings in the opposite order-->
											<li Class="XmlExtensions.Setting.Gap">
												<spacing>6</spacing>
											</li>
											<li Class="XmlExtensions.Setting.SplitColumn">
												<leftCol>
													<li Class="XmlExtensions.Setting.Section">
														<settings>
															<li Class="XmlExtensions.Setting.Checkbox">
																<label>{label}</label>
																<key>patch{stat}</key>
																<tKey>imranfish_moodmatters_{stat}</tKey>
																<highlight>false</highlight>
															</li>
															<li Class="XmlExtensions.Setting.Range">
																<key>{stat}min</key>
																<key2>{stat}max</key2>
																<defaultValue>{defaultMin}~{defaultMax}</defaultValue>
																<min>0</min>
																<max>200</max>
															</li>
														</settings>
													</li>
												</leftCol>
											</li>
										</value>
									</Operation>
									<!--Insert into rightCol next time-->
									<Operation Class="PatchOperationReplace">
										<xpath>Defs/XmlExtensions.SlateDef[@Name="MoodMatters_Slate"]/col</xpath>
										<value>
											<col>right</col>
										</value>
									</Operation>
								</apply>
							</li>
							<li>
								<!--RightCol case-->
								<value>right</value>
								<apply>
									<Operation Class="PatchOperationAdd">
										<xpath>Defs/XmlExtensions.SettingsMenuDef[modId="imranfish.moodmatters"]/settings/li[@Class="XmlExtensions.Setting.SplitColumn"][last()]</xpath>
										<value>
											<rightCol>
												<li Class="XmlExtensions.Setting.Section">
													<settings>
														<li Class="XmlExtensions.Setting.Checkbox">
															<label>{label}</label>
															<key>patch{stat}</key>
															<tKey>imranfish_moodmatters_{stat}</tKey>
															<highlight>false</highlight>
														</li>
														<li Class="XmlExtensions.Setting.Range">
															<key>{stat}min</key>
															<key2>{stat}max</key2>
															<defaultValue>{defaultMin}~{defaultMax}</defaultValue>
															<min>0</min>
															<max>200</max>
														</li>
													</settings>
												</li>
											</rightCol>
										</value>
									</Operation>
									<!--Insert into leftCol next time-->
									<Operation Class="PatchOperationReplace">
										<xpath>Defs/XmlExtensions.SlateDef[@Name="MoodMatters_Slate"]/col</xpath>
										<value>
											<col>left</col>
										</value>
									</Operation>
								</apply>
							</li>
						</cases>
					</Operation>
				</apply>
			</Operation>
		</apply>
	</XmlExtensions.PatchDef>
</Defs>
